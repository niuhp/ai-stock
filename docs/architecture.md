# AI Stock 系统架构设计文档

## 1. 架构总览

### 1.1 分层架构

```
┌──────────────────────────────────────────────────────────────────┐
│                          客户端层 (Client Layer)                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │
│  │   Web端    │  │   移动端    │  │   小程序    │  │  开放API   │ │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                        接入层 (Gateway Layer)                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │             Spring Cloud Gateway / Nginx                  │   │
│  │  • 身份认证  • 限流熔断  • 路由转发  • 日志记录          │   │
│  └──────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                       业务服务层 (Service Layer)                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │用户服务 │  │数据服务 │  │分析服务 │  │推荐服务 │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │组合服务 │  │监控服务 │  │通知服务 │  │报告服务 │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└──────────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                       数据&AI层 (Data & AI Layer)                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │数据采集 │  │数据清洗 │  │特征工程 │  │AI引擎   │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└──────────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                   基础设施层 (Infrastructure Layer)               │
│  ┌────────┐ ┌──────┐ ┌────┐ ┌────┐ ┌────┐ ┌────────────┐       │
│  │ MySQL  │ │Redis │ │ MQ │ │ ES │ │OSS │ │监控&告警   │       │
│  └────────┘ └──────┘ └────┘ └────┘ └────┘ └────────────┘       │
└──────────────────────────────────────────────────────────────────┘
```

## 2. 核心服务详细设计

### 2.1 用户服务 (ai-stock-user)

**职责**：
- 用户注册、登录、认证
- 用户信息管理
- 权限与角色管理
- 会员体系管理

**技术栈**：
- Spring Boot 3.x
- Spring Security + JWT
- MyBatis Plus
- Redis（会话缓存）

**数据库表**：
- tb_user
- tb_user_preference
- tb_role
- tb_permission

**对外接口**：
```
POST   /api/v1/users/register        # 用户注册
POST   /api/v1/users/login           # 用户登录
GET    /api/v1/users/profile         # 获取用户信息
PUT    /api/v1/users/profile         # 更新用户信息
PUT    /api/v1/users/preference      # 更新用户偏好
```

### 2.2 数据服务 (ai-stock-data)

**职责**：
- 股票数据采集（爬虫、API）
- 数据清洗与存储
- 数据查询接口
- 数据更新调度

**技术栈**：
- Spring Boot 3.x
- MyBatis Plus
- XXL-Job（定时任务）
- InfluxDB（时序数据）
- Caffeine（本地缓存）

**数据源**：
- 东方财富API
- 新浪财经API
- Tushare Pro
- 同花顺API（备用）

**数据库表**：
- tb_stock_info
- tb_stock_kline_*
- tb_stock_realtime
- tb_stock_financial
- tb_market_index

**对外接口**：
```
GET    /api/v1/stocks                # 股票列表
GET    /api/v1/stocks/{code}         # 股票详情
GET    /api/v1/stocks/{code}/kline   # K线数据
GET    /api/v1/stocks/{code}/realtime # 实时行情
GET    /api/v1/stocks/{code}/financial # 财务数据
```

### 2.3 分析服务 (ai-stock-analysis)

**职责**：
- 技术指标计算
- 技术分析
- 基本面分析
- 资金面分析
- 情绪分析

**技术栈**：
- Spring Boot 3.x
- Ta-Lib（技术指标库）
- Redis（缓存计算结果）
- RabbitMQ（异步任务）

**核心算法**：
```java
// 技术指标计算
- MACD (指数平滑异同移动平均线)
- KDJ (随机指标)
- RSI (相对强弱指标)
- BOLL (布林带)
- MA (移动平均线)
- EMA (指数移动平均线)
- 成交量分析
- 均线系统分析

// 形态识别
- 头肩顶/头肩底
- 双顶/双底
- 三角形整理
- 旗形整理
- 趋势线突破
```

**对外接口**：
```
GET    /api/v1/analysis/{code}/technical    # 技术分析
GET    /api/v1/analysis/{code}/fundamental  # 基本面分析
GET    /api/v1/analysis/{code}/capital      # 资金面分析
GET    /api/v1/analysis/{code}/sentiment    # 情绪分析
POST   /api/v1/analysis/batch               # 批量分析
```

### 2.4 AI推荐服务 (ai-stock-recommendation)

**职责**：
- AI模型调用
- 买卖点推荐
- 个性化推荐
- 推荐效果评估

**技术栈**：
- Spring Boot 3.x
- Python AI服务（Flask/FastAPI）
- gRPC（Java与Python通信）
- Redis（推荐结果缓存）

**AI模型架构**：
```
输入层（特征）：
  - 技术指标（30+维度）
  - 基本面指标（20+维度）
  - 资金流向指标（10+维度）
  - 情绪指标（5+维度）
  - 市场环境指标（10+维度）

隐藏层：
  - LSTM层（处理时序特征）
  - 全连接层（多层）
  - Dropout层（防止过拟合）

输出层：
  - 涨跌预测（分类）
  - 价格预测（回归）
  - 置信度评估
```

**评分模型**：
```
总分 = 技术面得分 × 0.35 
     + 基本面得分 × 0.30 
     + 资金面得分 × 0.20 
     + 情绪面得分 × 0.15

推荐级别：
  - 总分 ≥ 85: 强烈推荐
  - 75 ≤ 总分 < 85: 推荐
  - 65 ≤ 总分 < 75: 观察
  - 总分 < 65: 不推荐
```

**对外接口**：
```
GET    /api/v1/recommendations/buy          # 买入推荐
GET    /api/v1/recommendations/sell         # 卖出推荐
GET    /api/v1/recommendations/personalized # 个性化推荐
GET    /api/v1/recommendations/{id}         # 推荐详情
GET    /api/v1/recommendations/history      # 历史推荐
```

### 2.5 组合管理服务 (ai-stock-portfolio)

**职责**：
- 投资组合管理
- 收益计算
- 风险评估
- 组合优化建议

**技术栈**：
- Spring Boot 3.x
- MyBatis Plus
- Redis（组合数据缓存）

**核心算法**：
```
收益率计算：
  - 单只股票收益率 = (当前价 - 买入价) / 买入价
  - 组合收益率 = Σ(持仓比例 × 股票收益率)
  - 年化收益率 = (1 + 总收益率)^(365/持有天数) - 1

风险指标：
  - 最大回撤 = (峰值 - 谷值) / 峰值
  - 波动率 = 收益率标准差 × √252
  - 夏普比率 = (年化收益率 - 无风险利率) / 波动率
  - Beta系数 = Cov(组合收益, 市场收益) / Var(市场收益)

组合优化：
  - 马科维茨投资组合理论
  - 等权重配置
  - 风险平价配置
  - 行业分散化建议
```

**对外接口**：
```
POST   /api/v1/portfolios                   # 创建组合
GET    /api/v1/portfolios                   # 组合列表
GET    /api/v1/portfolios/{id}              # 组合详情
POST   /api/v1/portfolios/{id}/positions    # 添加持仓
DELETE /api/v1/portfolios/{id}/positions/{posId} # 删除持仓
GET    /api/v1/portfolios/{id}/analysis     # 组合分析
GET    /api/v1/portfolios/{id}/optimize     # 组合优化建议
```

### 2.6 监控预警服务 (ai-stock-monitor)

**职责**：
- 实时行情监控
- 异动检测
- 预警规则匹配
- 消息推送

**技术栈**：
- Spring Boot 3.x
- WebSocket（实时推送）
- Redis Pub/Sub（消息分发）
- RabbitMQ（预警消息队列）
- Drools（规则引擎）

**监控策略**：
```
价格监控：
  - 涨停/跌停
  - 突破支撑位/压力位
  - 价格到达预设值

成交量监控：
  - 放量/缩量
  - 量价背离
  - 大单成交

技术指标监控：
  - 金叉/死叉
  - 指标超买/超卖
  - 技术形态突破

AI评分监控：
  - 评分大幅变化
  - 推荐级别变化
  - 风险等级上升
```

**对外接口**：
```
GET    /api/v1/watchlist                    # 自选股列表
POST   /api/v1/watchlist                    # 添加自选股
DELETE /api/v1/watchlist/{id}               # 删除自选股
POST   /api/v1/alerts/rules                 # 创建预警规则
GET    /api/v1/alerts/rules                 # 预警规则列表
GET    /api/v1/alerts/logs                  # 预警记录
WS     ws://api/domain.com/v1/realtime      # WebSocket实时推送
```

### 2.7 报告服务 (ai-stock-report)

**职责**：
- 分析报告生成
- 报告模板管理
- 报告导出（PDF/Excel）
- 报告历史管理

**技术栈**：
- Spring Boot 3.x
- Thymeleaf（报告模板）
- iText（PDF生成）
- Apache POI（Excel生成）
- MinIO/OSS（报告存储）

**报告类型**：
```
个股分析报告：
  - 基本信息
  - 技术分析
  - 基本面分析
  - AI评分
  - 推荐建议

组合分析报告：
  - 组合概览
  - 持仓分布
  - 收益分析
  - 风险分析
  - 优化建议

周度/月度报告：
  - 市场回顾
  - 组合表现
  - 推荐回顾
  - 下期展望
```

**对外接口**：
```
POST   /api/v1/reports/stock                # 生成个股报告
POST   /api/v1/reports/portfolio            # 生成组合报告
GET    /api/v1/reports                      # 报告列表
GET    /api/v1/reports/{id}                 # 报告详情
GET    /api/v1/reports/{id}/download        # 下载报告
```

### 2.8 通知服务 (ai-stock-notification)

**职责**：
- 消息推送（站内信、短信、邮件、App推送）
- 消息模板管理
- 消息记录查询

**技术栈**：
- Spring Boot 3.x
- RabbitMQ（消息队列）
- WebSocket（站内消息推送）
- 阿里云短信SDK
- JavaMail（邮件）
- 极光推送（App推送）

**消息类型**：
```
系统通知：
  - 账户变更
  - 功能更新
  - 系统维护

交易提醒：
  - 买入推荐
  - 卖出建议
  - 止损提醒

监控预警：
  - 价格预警
  - 异动提醒
  - 风险预警

报告推送：
  - 分析报告就绪
  - 周报/月报推送
```

**对外接口**：
```
POST   /api/v1/notifications/send           # 发送消息
GET    /api/v1/notifications                # 消息列表
PUT    /api/v1/notifications/{id}/read      # 标记已读
DELETE /api/v1/notifications/{id}           # 删除消息
```

## 3. 数据架构

### 3.1 数据存储策略

#### 3.1.1 MySQL（关系型数据）
```
用途：
  - 用户数据
  - 股票基本信息
  - 投资组合数据
  - 推荐记录
  - 预警规则

分库分表策略：
  - 按用户ID分库（user_db_0, user_db_1, ...）
  - 按股票代码分表（stock_info_0, stock_info_1, ...）
  - K线数据按日期分表（kline_202401, kline_202402, ...）

读写分离：
  - 主库：写操作
  - 从库：读操作（2个从库，负载均衡）
```

#### 3.1.2 InfluxDB（时序数据）
```
用途：
  - K线数据（分钟K、日K）
  - 实时行情数据
  - 技术指标数据
  - 系统监控指标

数据保留策略：
  - 实时行情：保留7天
  - 分钟K：保留1年
  - 日K：永久保留
  - 监控数据：保留30天
```

#### 3.1.3 Redis（缓存）
```
用途：
  - 用户会话（JWT Token）
  - 实时行情缓存
  - 热点股票数据缓存
  - 分布式锁
  - 限流计数器

数据结构：
  - String: 简单KV缓存
  - Hash: 股票实时行情
  - List: 消息队列
  - Set: 自选股列表
  - Sorted Set: 推荐排行榜
  - Bitmap: 用户签到

缓存策略：
  - 用户会话：TTL 7天
  - 实时行情：TTL 5秒
  - 股票信息：TTL 1小时
  - AI评分：TTL 1天
```

#### 3.1.4 Elasticsearch（搜索&日志）
```
用途：
  - 股票搜索（支持拼音、简码）
  - 新闻资讯搜索
  - 系统日志检索
  - 用户行为分析

索引设计：
  - stock_index: 股票信息索引
  - news_index: 新闻资讯索引
  - access_log_*: 访问日志（按日期滚动）
  - error_log_*: 错误日志（按日期滚动）
```

#### 3.1.5 RabbitMQ（消息队列）
```
用途：
  - 异步任务处理
  - 服务解耦
  - 削峰填谷
  - 消息推送

Exchange类型：
  - Direct: 点对点消息
  - Topic: 主题订阅
  - Fanout: 广播消息

队列设计：
  - data.collection.queue: 数据采集队列
  - analysis.task.queue: 分析任务队列
  - notification.queue: 通知消息队列
  - alert.queue: 预警消息队列
```

### 3.2 数据流转

```
┌──────────────┐
│  外部数据源   │ (东方财富、新浪财经、Tushare)
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  数据采集层   │ (定时任务、实时爬虫)
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  数据清洗层   │ (去重、验证、格式化)
└──────┬───────┘
       │
       ├──────────────────────────┐
       │                          │
       ▼                          ▼
┌──────────────┐          ┌──────────────┐
│  MySQL存储   │          │ InfluxDB存储 │
│ (基础数据)   │          │ (时序数据)   │
└──────┬───────┘          └──────┬───────┘
       │                          │
       └──────────┬───────────────┘
                  │
                  ▼
          ┌──────────────┐
          │  Redis缓存   │
          └──────┬───────┘
                 │
                 ▼
          ┌──────────────┐
          │  业务服务层   │ (分析、推荐、监控)
          └──────┬───────┘
                 │
                 ▼
          ┌──────────────┐
          │   客户端     │
          └──────────────┘
```

## 4. 技术选型详解

### 4.1 后端技术栈

| 技术 | 版本 | 用途 | 替代方案 |
|------|------|------|---------|
| Java | 17 LTS | 开发语言 | Java 21 |
| Spring Boot | 3.2.x | 基础框架 | Quarkus, Micronaut |
| Spring Cloud | 2023.0.x | 微服务治理 | Dubbo |
| Spring Cloud Alibaba | 2022.0.x | 扩展组件 | - |
| Nacos | 2.3.x | 注册中心&配置中心 | Consul, Eureka |
| Sentinel | 1.8.x | 限流熔断 | Hystrix, Resilience4j |
| MyBatis Plus | 3.5.x | ORM框架 | JPA, jOOQ |
| MySQL | 8.0 | 关系数据库 | PostgreSQL |
| Redis | 7.x | 缓存&消息 | Memcached, Hazelcast |
| RabbitMQ | 3.12.x | 消息队列 | Kafka, RocketMQ |
| InfluxDB | 2.7.x | 时序数据库 | TimescaleDB, OpenTSDB |
| Elasticsearch | 8.x | 搜索引擎 | Solr, OpenSearch |
| XXL-Job | 2.4.x | 任务调度 | Quartz, Elastic-Job |

### 4.2 AI技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.10+ | AI开发语言 |
| TensorFlow | 2.x | 深度学习框架 |
| PyTorch | 2.x | 深度学习框架（备选） |
| Scikit-learn | 1.x | 传统机器学习 |
| Pandas | 2.x | 数据处理 |
| NumPy | 1.x | 数值计算 |
| Ta-Lib | 0.4.x | 技术指标计算 |
| Flask/FastAPI | - | AI服务框架 |
| gRPC | - | Java-Python通信 |

### 4.3 运维技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Docker | 24.x | 容器化 |
| Kubernetes | 1.28.x | 容器编排 |
| Jenkins | 2.x | CI/CD |
| Prometheus | 2.x | 监控 |
| Grafana | 10.x | 可视化 |
| ELK Stack | 8.x | 日志收集分析 |
| SkyWalking | 9.x | 链路追踪 |
| Nginx | 1.24.x | 负载均衡 |

## 5. 高可用设计

### 5.1 服务高可用

```
策略：
  1. 服务冗余：每个服务至少3个实例
  2. 健康检查：定期检查服务健康状态
  3. 自动恢复：异常服务自动重启
  4. 优雅下线：停机前完成当前请求
  5. 限流熔断：保护服务不被压垮

实现：
  - Kubernetes: 自动重启、健康检查
  - Sentinel: 限流、熔断、降级
  - Spring Retry: 重试机制
```

### 5.2 数据库高可用

```
MySQL:
  - 主从复制（1主2从）
  - 半同步复制（保证数据一致性）
  - MHA自动故障切换
  - 读写分离（主库写、从库读）

Redis:
  - 哨兵模式（Sentinel）
  - 自动故障转移
  - 数据持久化（RDB + AOF）
  - 主从复制

InfluxDB:
  - 集群模式
  - 数据复制（3副本）
  - 自动分片
```

### 5.3 降级策略

```
降级优先级：
  P0（核心功能）- 不降级
    - 用户登录
    - 实时行情查询
    - 持仓查询

  P1（重要功能）- 有损降级
    - AI分析：返回缓存数据
    - 推荐服务：返回基础推荐

  P2（次要功能）- 快速降级
    - 报告生成：异步生成
    - 历史数据查询：限制查询范围

  P3（辅助功能）- 完全降级
    - 新闻资讯
    - 数据导出
```

## 6. 性能优化

### 6.1 数据库优化

```
索引优化：
  - 为常用查询字段建立索引
  - 使用覆盖索引减少回表
  - 定期分析和优化索引

查询优化：
  - 避免SELECT *
  - 使用分页查询
  - 批量操作代替单条操作
  - 使用JOIN代替多次查询

分库分表：
  - 按用户ID分库
  - 按时间分表
  - 使用ShardingSphere
```

### 6.2 缓存优化

```
多级缓存：
  L1: 本地缓存（Caffeine）- 响应时间 < 1ms
  L2: Redis缓存 - 响应时间 < 10ms
  L3: 数据库 - 响应时间 < 100ms

缓存策略：
  - Cache-Aside: 先查缓存，miss则查DB并更新缓存
  - Write-Through: 写入时同步更新缓存
  - Write-Behind: 异步更新缓存

缓存预热：
  - 系统启动时加载热点数据
  - 定时刷新缓存
  - 使用布隆过滤器防止缓存穿透
```

### 6.3 异步处理

```
异步场景：
  - 数据采集：使用消息队列异步处理
  - AI分析：放入任务队列，异步计算
  - 报告生成：异步生成，完成后通知用户
  - 消息推送：异步发送

实现方式：
  - @Async注解
  - CompletableFuture
  - RabbitMQ
  - 线程池
```

## 7. 安全架构

### 7.1 网络安全

```
防火墙配置：
  - 只开放必要端口（80, 443）
  - 内部服务间使用内网通信
  - 数据库不对外暴露

HTTPS：
  - 全站HTTPS
  - TLS 1.3
  - 证书自动续期

DDoS防护：
  - CDN加速
  - 流量清洗
  - 黑名单IP封禁
```

### 7.2 应用安全

```
身份认证：
  - JWT Token
  - Token续期机制
  - Token黑名单

权限控制：
  - RBAC模型
  - 方法级权限控制
  - 数据权限隔离

输入验证：
  - 参数校验（@Valid）
  - SQL注入防护
  - XSS防护
  - CSRF防护

接口安全：
  - 接口签名
  - 时间戳验证
  - 防重放攻击
  - 限流防刷
```

### 7.3 数据安全

```
数据加密：
  - 密码：BCrypt加密
  - 敏感信息：AES加密
  - 传输：HTTPS加密

数据脱敏：
  - 日志脱敏
  - 接口返回脱敏
  - 数据库字段加密

数据备份：
  - 每日全量备份
  - 实时binlog备份
  - 异地备份
  - 定期恢复演练
```

## 8. 监控告警架构

### 8.1 监控体系

```
基础监控：
  - 主机监控：CPU、内存、磁盘、网络
  - 容器监控：Pod状态、资源使用
  - 中间件监控：数据库、Redis、MQ

应用监控：
  - JVM监控：堆内存、GC、线程
  - 接口监控：QPS、响应时间、错误率
  - 业务监控：用户量、交易量、推荐准确率

链路监控：
  - 分布式追踪
  - 调用链路分析
  - 性能瓶颈定位

日志监控：
  - 日志收集：Filebeat
  - 日志存储：Elasticsearch
  - 日志分析：Kibana
  - 日志告警：ElastAlert
```

### 8.2 告警规则

```
基础告警：
  - CPU > 80% 持续5分钟
  - 内存 > 85% 持续5分钟
  - 磁盘 > 80%
  - 网络异常

应用告警：
  - 服务不可用
  - 接口错误率 > 5%
  - 接口响应时间 > 3s (P95)
  - QPS异常波动（> 50%）

业务告警：
  - 数据采集失败
  - AI模型预测异常
  - 推荐服务异常
  - 用户量异常下降

数据库告警：
  - 主从延迟 > 10s
  - 慢查询增多
  - 连接数 > 80%
  - 死锁发生
```

## 9. 扩展性设计

### 9.1 横向扩展

```
无状态服务：
  - 所有服务设计为无状态
  - 会话存储在Redis
  - 可随时增加实例

自动扩缩容：
  - HPA（Horizontal Pod Autoscaler）
  - 基于CPU/内存指标
  - 基于业务指标（QPS）

数据库扩展：
  - 分库分表
  - 读写分离
  - 从库可动态增加
```

### 9.2 垂直扩展

```
服务器升级：
  - 支持配置升级
  - 滚动升级，不停机

资源优化：
  - JVM参数调优
  - 数据库参数优化
  - 连接池配置优化
```

### 9.3 国际化扩展

```
预留扩展点：
  - 数据源接口化
  - 支持多市场配置
  - 多语言支持
  - 多时区支持

未来可扩展市场：
  - 港股市场
  - 美股市场
  - 其他海外市场
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-14

